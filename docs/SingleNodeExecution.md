# 单节点执行功能

## 概述

单节点执行功能允许用户单独执行工作流中的任意节点，而不需要执行整个工作流。这对于测试、调试和验证单个节点的功能非常有用。

## 功能特性

### 1. 单节点执行
- 点击节点上的播放按钮即可单独执行该节点
- 支持所有类型的节点：开始、点击、输入、等待、截图、滚动、滑动、条件、循环、关闭
- 执行过程中会显示详细的日志信息

### 2. 配置验证
- 自动验证节点配置的完整性
- 检查必需参数是否存在
- 验证参数类型是否正确

### 3. 错误处理
- 自动重试机制（默认3次）
- 超时保护（默认30秒）
- 详细的错误日志和堆栈信息

### 4. 性能监控
- 执行时间统计
- 性能等级评估（快速/正常/缓慢/极慢）
- 执行结果格式化

## 使用方法

### 1. 基本使用
1. 在工作流编辑器中添加节点
2. 配置节点的参数
3. 点击节点右上角的播放按钮（▶️）
4. 查看执行日志和结果

### 2. 支持的节点类型

#### 开始节点
- **功能**: 启动应用程序
- **必需配置**: 应用名称
- **可选配置**: 启动方式、等待时间

#### 点击节点
- **功能**: 点击界面元素
- **必需配置**: 选择器或坐标
- **可选配置**: 点击类型、等待时间、重试次数

#### 输入节点
- **功能**: 输入文本到界面元素
- **必需配置**: 选择器、输入文本
- **可选配置**: 是否清空、等待时间、重试次数

#### 等待节点
- **功能**: 等待指定时间
- **必需配置**: 等待时长
- **可选配置**: 等待单位、等待类型

#### 截图节点
- **功能**: 截取屏幕图像
- **可选配置**: 文件名、是否全屏、选择器、格式

#### 滚动节点
- **功能**: 滚动界面
- **必需配置**: 滚动方向、距离
- **可选配置**: 是否平滑、滚动速度

#### 滑动节点
- **功能**: 滑动操作
- **可选配置**: 起始坐标、结束坐标、滑动时长

#### 条件节点
- **功能**: 条件判断
- **必需配置**: 选择器、操作符
- **可选配置**: 比较值、等待时间、重试次数

#### 循环节点
- **功能**: 循环执行
- **必需配置**: 循环类型、循环次数
- **可选配置**: 最大迭代次数、等待时间

#### 关闭节点
- **功能**: 关闭应用程序
- **可选配置**: 关闭方式、目标应用、等待时间

## 技术实现

### 1. 架构设计
```
渲染进程 (Renderer)
    ↓ IPC调用
主进程 (Main Process)
    ↓ 调用
工作流执行器 (WorkflowExecutor)
    ↓ 执行
节点执行逻辑 (Node Logic)
    ↓ 调用
HDC命令执行 (HDC Commands)
```

### 2. 关键组件

#### 渲染进程
- `Automation.tsx`: 主工作流组件
- `nodes/*.tsx`: 各种节点组件
- `workflow-controls.tsx`: 工作流控制组件

#### 主进程
- `workflow.ts`: 工作流执行器
- `handlers.ts`: IPC处理程序
- `node-executor.ts`: 节点执行器基类

#### 类型定义
- `types/workflow.ts`: 工作流相关类型
- `preload/index.d.ts`: API类型定义

### 3. 执行流程

1. **用户点击单节点执行按钮**
2. **渲染进程调用API**
   ```typescript
   await window.api.executeSingleNode(node, connectKey);
   ```

3. **主进程接收IPC调用**
   ```typescript
   ipcMain.handle("execute-single-node", async (_, node, connectKey) => {
     await workflowExecutor.executeSingleNode(node, connectKey);
   });
   ```

4. **工作流执行器执行节点**
   ```typescript
   async executeSingleNode(node: WorkflowNode, connectKey: string): Promise<void> {
     // 验证配置
     this.validateNodeConfig(node);
     
     // 执行节点逻辑
     const result = await this.executeNodeLogic(node);
     
     // 记录执行结果
     this.addLog("single-node", "success", "单节点执行完成");
   }
   ```

5. **更新执行上下文**
   - 通过IPC发送状态更新到渲染进程
   - 更新节点状态和日志信息

## 错误处理

### 1. 配置验证错误
- 检查必需参数是否存在
- 验证参数类型是否正确
- 提供详细的错误信息

### 2. 执行错误
- 自动重试机制（最多3次）
- 超时保护（30秒）
- 详细的错误日志

### 3. 网络/设备错误
- HDC命令执行失败重试
- 设备连接状态检查
- 命令执行结果验证

## 性能优化

### 1. 执行时间监控
- 记录每个节点的执行时间
- 性能等级评估
- 慢节点识别

### 2. 资源管理
- 及时清理临时资源
- 避免内存泄漏
- 优化日志记录

### 3. 并发控制
- 防止重复执行
- 状态同步
- 资源锁定

## 调试和测试

### 1. 日志查看
- 执行日志对话框
- 实时状态更新
- 详细错误信息

### 2. 测试工具
- `test-single-node.ts`: 单节点执行测试
- 配置验证测试
- 性能基准测试

### 3. 常见问题
- 设备连接问题
- 配置参数错误
- 执行超时问题

## 最佳实践

### 1. 节点配置
- 确保所有必需参数都已配置
- 使用合适的等待时间
- 设置合理的重试次数

### 2. 错误处理
- 查看详细日志信息
- 检查设备连接状态
- 验证节点配置

### 3. 性能优化
- 避免过长的等待时间
- 使用合适的重试策略
- 监控执行性能

## 未来改进

### 1. 功能增强
- 批量节点执行
- 节点执行历史
- 执行结果缓存

### 2. 用户体验
- 更直观的执行状态显示
- 更好的错误提示
- 执行进度条

### 3. 性能优化
- 并行执行支持
- 更智能的重试策略
- 资源使用优化
